#!/bin/sh

_deps="$HOME/usr/src/eudald-kiss/metapkg/depends"
_live="$HOME/usr/src/kiss-live"

case "$1" in
    alternatives|build|checksum|download|install|list|remove|search|update|version|''|help-ext|\
    chroot|depends|export|fork|help|link|maintainer|manifest|new|orphans|outdated|owns|reset|revdepends|size)
        /usr/bin/kiss "$@"
    ;;
    add|del)
        _1="$1"
        shift 1
        [ "$#" -ne 0 ] && {
            for _pkg in "$@"; do
                if [ -n "$(cat $_deps | grep -w $_pkg)" ]; then
                    [ "$_1" = del ] && { sed -i "/^$_pkg$/d" "$_deps"; ch=1; }
                else
                    [ "$_1" = add ] && { echo "$_pkg" >> "$_deps"; ch=1; }
                fi
            done

            [ "$ch" = 1 ] && {
                sort -uk1,1 "$_deps" -o "$_deps"
                KISS_PROMPT=0 kiss bi metapkg; kiss ro
            }
        }
    ;;
    live)
        shift 1
        for _pkg in grub libisoburn squashfs-tools syslinux; do
            [ -d "/var/db/kiss/installed/$_pkg" ] || {
                kiss i "$_pkg" || kiss bi "$_pkg"
            }
        done
        
        ( cd "$_live"; sls ./kiss-live "$@"; cd - )
    ;;
    ro)
        while kiss o | grep -qv "${2:-metapkg}"; do
            kiss r `kiss o | grep -v "${2:-metapkg}" | tr '\n' ' '`
        done
    ;;
    *)
        _1="$1"
        shift 1
        for _action in $(echo "$_1" | grep -o .); do
            /usr/bin/kiss "$_action" "$@"
        done
    ;;
esac
