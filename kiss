#!/bin/sh -e

case "$1" in
    alternatives|build|checksum|download|install|list|remove|search|update|version|''|help-ext|\
    chroot|depends|export|fork|help|link|maintainer|manifest|new|orphans|outdated|owns|reset|revdepends|size)
        /usr/bin/kiss "$@"
    ;;
    add)
        shift 1
        [ "$#" -ne 0 ] && {
            for _pkg in "$@"; do
                [ $(cat $HOME/usr/src/eudald-kiss/metapkg/depends | grep -w "$_pkg") ] || {
                    echo "$_pkg" >> $HOME/usr/src/eudald-kiss/metapkg/depends
                    added=true
                }
            done
            [ "$added" ] && kiss bi metapkg
        }
    ;;
    del)
        shift 1
        [ "$#" -ne 0 ] && {
            for _pkg in "$@"; do
                [ $(cat $HOME/usr/src/eudald-kiss/metapkg/depends | grep -w "$_pkg") ] && {
                    sed -i "/$_pkg/d" $HOME/usr/src/eudald-kiss/metapkg/depends
                    deleted=true
                }
            done
            [ "$deleted" ] && { kiss bi metapkg; kiss ro; }
        }
    ;;
    live)
        shift 1
        for _pkg in grub libisoburn squashfs-tools syslinux; do
            [ -d "/var/db/kiss/installed/$_pkg" ] || kiss bi "$_pkg"
        done
        
        (
            cd $HOME/usr/src/kiss-live

            sls ./kiss-live "$@"

            cd -
        )
    ;;
    ro)
        while kiss o | grep -qv "${2:-metapkg}"; do
            kiss r `kiss o | grep -v "${2:-metapkg}" | tr '\n' ' '`
        done
    ;;
    *)
        _1="$1"
        shift 1
        for _action in $(echo "$_1" | grep -o .); do
            [ "$_action" = u ] && {
                /usr/bin/kiss "$_action"
            } || {
                /usr/bin/kiss "$_action" "$@"
            }
        done
    ;;
esac
